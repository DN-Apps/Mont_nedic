name: QA Build & Deploy (qa-rent)

on:
  push:
    branches: [ "qa" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

env:
  REGISTRY: ghcr.io
  OWNER: dn-apps
  IMAGE_CLIENT: ghcr.io/dn-apps/rent-client
  IMAGE_SERVER: ghcr.io/dn-apps/rent-server
  # Fallback falls kein Secret gesetzt:
  API_PUBLIC_URL_QA: ${{ secrets.API_PUBLIC_URL_QA || 'https://qa-rent.ned-it.de/api' }}

jobs:
  build:
    name: Build & Push Images (client/server)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [ client, server ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login (GHCR)
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login "$REGISTRY" -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      - name: Build & Push
        run: |
          if [[ "${{ matrix.service }}" == "client" ]]; then
            IMAGE="${IMAGE_CLIENT}"
            DOCKERFILE="client/Dockerfile"
            BUILD_ARGS=( --build-arg "API_PUBLIC_URL=${API_PUBLIC_URL_QA}" )
          else
            IMAGE="${IMAGE_SERVER}"
            DOCKERFILE="server/Dockerfile"
            BUILD_ARGS=()
          fi

          echo "Building $IMAGE using $DOCKERFILE"
          docker build \
            -f "$DOCKERFILE" \
            "${BUILD_ARGS[@]}" \
            -t "$IMAGE:qa" \
            -t "$IMAGE:${GITHUB_SHA}" \
            .

          echo "Pushing $IMAGE:qa and $IMAGE:${GITHUB_SHA}"
          docker push "$IMAGE:qa"
          docker push "$IMAGE:${GITHUB_SHA}"

  deploy:
    name: Deploy to QA Server
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Validate secrets
        run: |
          [[ -n "${{ secrets.SSH_HOST }}" ]] || { echo "Missing secret: SSH_HOST"; exit 1; }
          [[ -n "${{ secrets.SSH_USER }}" ]] || { echo "Missing secret: SSH_USER"; exit 1; }
          [[ -n "${{ secrets.SSH_KEY }}"  ]] || { echo "Missing secret: SSH_KEY";  exit 1; }
          [[ -n "${{ secrets.REGISTRY_USER }}" ]] || { echo "Missing secret: REGISTRY_USER"; exit 1; }
          [[ -n "${{ secrets.GHCR_TOKEN }}" ]] || { echo "Missing secret: GHCR_TOKEN"; exit 1; }

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd /srv/docker/qa/rent/compose

            echo "[1/6] Docker login to GHCR"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USER }}" --password-stdin

            echo "[2/6] Pull latest images"
            docker compose -f docker-compose.qa.yml pull

            echo "[3/6] Start/Update stack"
            docker compose -f docker-compose.qa.yml up -d

            echo "[4/6] Wait for health (server & client)"
            timeout 120 bash -c '
              until [ "$(docker inspect -f {{.State.Health.Status}} qa-rent-server)" = "healthy" ] \
                 && [ "$(docker inspect -f {{.State.Health.Status}} qa-rent-client)" = "healthy" ]; do
                sleep 3
              done
            '

            echo "[5/6] Idempotent DB schema (firmen, benutzerdaten)"
            set -a; source .env; set +a
            docker exec qa-rent-db sh -lc "mysql -u\"\$MYSQL_USER\" -p\"\$MYSQL_PASSWORD\" \"\$MYSQL_DATABASE\" -e \"
              CREATE TABLE IF NOT EXISTS firmen (
                id INT UNSIGNED NOT NULL AUTO_INCREMENT,
                name VARCHAR(255) NOT NULL,
                created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (id)
              ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

              CREATE TABLE IF NOT EXISTS benutzerdaten (
                id INT UNSIGNED NOT NULL AUTO_INCREMENT,
                email VARCHAR(320) NOT NULL,
                display_name VARCHAR(255) NULL,
                created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (id),
                UNIQUE KEY uniq_email (email)
              ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
            \""

            echo "[6/6] Smoke checks"
            docker exec qa-rent-server wget -qO- http://127.0.0.1:5000/api/health | tee /tmp/health.json
            curl -fsS -m 10 http://qa-rent.ned-it.de/api/health | tee /tmp/health_ext.json || true

            echo "Deploy done."
