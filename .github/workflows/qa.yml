name: QA Build & Deploy (qa-rent)

on:
  push:
    branches: [ "qa" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

env:
  REGISTRY: ghcr.io
  OWNER: dn-apps
  IMAGE_CLIENT: ghcr.io/dn-apps/rent-client
  IMAGE_SERVER: ghcr.io/dn-apps/rent-server
  # ohne /api, damit kein doppeltes /api/api entsteht
  API_PUBLIC_URL_QA: ${{ secrets.API_PUBLIC_URL_QA || 'https://qa-rent.ned-it.de' }}

jobs:
  build:
    name: Build & Push Images (client/server)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [ client, server ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & Push client
        if: matrix.service == 'client'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: client/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_CLIENT }}:qa
            ${{ env.IMAGE_CLIENT }}:${{ github.sha }}
          build-args: |
            API_PUBLIC_URL=${{ env.API_PUBLIC_URL_QA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Build & Push server
        if: matrix.service == 'server'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: server/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_SERVER }}:qa
            ${{ env.IMAGE_SERVER }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  deploy:
    name: Deploy to QA Server
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Validate secrets
        run: |
          [[ -n "${{ secrets.SSH_HOST }}" ]] || { echo "Missing secret: SSH_HOST"; exit 1; }
          [[ -n "${{ secrets.SSH_USER }}" ]] || { echo "Missing secret: SSH_USER"; exit 1; }
          [[ -n "${{ secrets.SSH_KEY }}"  ]] || { echo "Missing secret: SSH_KEY";  exit 1; }
          [[ -n "${{ secrets.REGISTRY_USER }}" ]] || { echo "Missing secret: REGISTRY_USER"; exit 1; }
          [[ -n "${{ secrets.GHCR_TOKEN }}" ]] || { echo "Missing secret: GHCR_TOKEN"; exit 1; }

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            trap 'echo ""; echo "---- Last 120 lines of server logs ----"; docker logs --tail=120 qa-rent-server || true; echo "---- Last 120 lines of client logs ----"; docker logs --tail=120 qa-rent-client || true; echo "----------------------------------------"' ERR

            cd /srv/docker/qa/rent/compose

            echo "[1/8] Docker login to GHCR"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USER }}" --password-stdin

            echo "[2/8] Compose config (debug: images)"
            docker compose -f docker-compose.qa.yml config >/tmp/compose.rendered.yml
            sed -n 's/ *image: //p' /tmp/compose.rendered.yml || true

            echo "[3/8] Pull latest images"
            docker compose -f docker-compose.qa.yml pull

            echo "[4/8] Start/Update stack"
            docker compose -f docker-compose.qa.yml up -d

            echo "[5/8] Verify DB credentials"
            set -a; source .env; set +a
            docker exec qa-rent-db sh -lc 'mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -e "SELECT 1"'

            echo "[6/8] Apply schema (idempotent)"
            docker exec qa-rent-db sh -lc 'mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -e "CREATE TABLE IF NOT EXISTS firmen (id INT UNSIGNED NOT NULL AUTO_INCREMENT, name VARCHAR(255) NOT NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;"'
            docker exec qa-rent-db sh -lc 'mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" -e "CREATE TABLE IF NOT EXISTS benutzerdaten (id INT UNSIGNED NOT NULL AUTO_INCREMENT, email VARCHAR(320) NOT NULL, display_name VARCHAR(255) NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (id), UNIQUE KEY uniq_email (email)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;"'

            echo "[7/8] Wait for health (server -> client)"
            # robust gegen set -e: interne Schleife ohne 'errexit'
            timeout 240 bash -c '
              set +e
              while true; do
                s1=$(docker inspect -f "{{.State.Health.Status}}" qa-rent-server 2>/dev/null || echo "unknown")
                s2=$(docker inspect -f "{{.State.Health.Status}}" qa-rent-client 2>/dev/null || echo "unknown")
                echo "health => server=${s1}  client=${s2}"
                if [ "$s1" = "healthy" ] && [ "$s2" = "healthy" ]; then exit 0; fi
                sleep 3
              done
            '

            echo "[8/8] Smoke checks"
            docker exec qa-rent-server sh -lc 'curl -fsS http://127.0.0.1:${PORT:-5000}/api/health' | tee /tmp/health.json
            curl -fsS -m 10 http://qa-rent.ned-it.de/api/health | tee /tmp/health_ext.json || true

            echo "Deploy done."
